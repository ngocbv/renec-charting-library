!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Datafeeds={})}(this,function(e){"use strict";var s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])})(e,t)};function n(e){return void 0===e?"":"string"==typeof e?e:e.message}var i=(t.prototype.getBars=function(e,t,s){var r=this,o={symbol:e.ticker||"",resolution:t,from:s.from,to:s.to,countback:s.countBack};return void 0!==e.currency_code&&(o.currencyCode=e.currency_code),new Promise(function(a,u){r._requester.sendRequest(r._datafeedUrl,"history",o).then(function(e){if("ok"===e.s||"no_data"===e.s){var t=[],s={noData:!1};if("no_data"===e.s)s.noData=!0,s.nextTime=e.nextTime;else for(var r=void 0!==e.v,o=void 0!==e.o,n=0;n<e.t.length;++n){var i={time:1e3*e.t[n],close:parseFloat(e.c[n]),open:parseFloat(e.c[n]),high:parseFloat(e.c[n]),low:parseFloat(e.c[n])};o&&(i.open=parseFloat(e.o[n]),i.high=parseFloat(e.h[n]),i.low=parseFloat(e.l[n])),r&&(i.volume=parseFloat(e.v[n])),t.push(i)}a({bars:t,meta:s})}else u(e.errmsg)}).catch(function(e){e=n(e);console.warn("HistoryProvider: getBars() failed, error="+e),u(e)})})},t);function t(e,t){this._datafeedUrl=e,this._requester=t}var a=(r.prototype.subscribeBars=function(e,t,s,r){this._subscribers.hasOwnProperty(r)||(this._subscribers[r]={lastBarTime:null,listener:s,resolution:t,symbolInfo:e},e.name)},r.prototype.unsubscribeBars=function(e){delete this._subscribers[e]},r.prototype._updateData=function(){var t=this;if(!(0<this._requestsPending)){this._requestsPending=0;var e,s,r=this;for(e in this._subscribers)s=e,r._requestsPending+=1,r._updateDataForSubscriber(s).then(function(){--t._requestsPending,t._requestsPending}).catch(function(e){--t._requestsPending,n(e),t._requestsPending})}},r.prototype._updateDataForSubscriber=function(t){var s=this,e=this._subscribers[t],r=parseInt((Date.now()/1e3).toString()),o=r-function(e,t){var s=0;s="D"===e||"1D"===e?t:"M"===e||"1M"===e?31*t:"W"===e||"1W"===e?7*t:t*parseInt(e)/1440;return 24*s*60*60}(e.resolution,10);return this._historyProvider.getBars(e.symbolInfo,e.resolution,{from:o,to:r,countBack:2,firstDataRequest:!1}).then(function(e){s._onSubscriberDataReceived(t,e)})},r.prototype._onSubscriberDataReceived=function(e,t){if(this._subscribers.hasOwnProperty(e)){var s=t.bars;if(0!==s.length){t=s[s.length-1],e=this._subscribers[e];if(!(null!==e.lastBarTime&&t.time<e.lastBarTime)){if(null!==e.lastBarTime&&t.time>e.lastBarTime){if(s.length<2)throw new Error("Not enough bars in history for proper pulse update. Need at least 2.");s=s[s.length-2];e.listener(s)}e.lastBarTime=t.time,e.listener(t)}}}},r);function r(e,t){this._subscribers={},this._requestsPending=0,this._historyProvider=e,setInterval(this._updateData.bind(this),t)}var u=(o.prototype.subscribeQuotes=function(e,t,s,r){this._subscribers[r]={symbols:e,fastSymbols:t,listener:s}},o.prototype.unsubscribeQuotes=function(e){delete this._subscribers[e]},o.prototype._updateQuotes=function(e){var r=this;if(!(0<this._requestsPending)){var t,o=this;for(t in this._subscribers)!function(t){o._requestsPending++;var s=o._subscribers[t];o._quotesProvider.getQuotes(1===e?s.fastSymbols:s.symbols).then(function(e){r._requestsPending--,r._subscribers.hasOwnProperty(t)&&(s.listener(e),r._requestsPending)}).catch(function(e){r._requestsPending--,n(e),r._requestsPending})}(t)}},o);function o(e){this._subscribers={},this._requestsPending=0,this._quotesProvider=e,setInterval(this._updateQuotes.bind(this,1),1e4),setInterval(this._updateQuotes.bind(this,0),6e4)}function l(e,t,s,r){t=e[t];return!Array.isArray(t)||r&&!Array.isArray(t[0])?t:t[s]}function p(e,t){return e+(void 0!==t?"_%|#|%_"+t:"")}var c=(h.prototype.resolveSymbol=function(t,s){var r=this;return this._readyPromise.then(function(){var e=r._symbolsInfo[p(t,s)];return void 0===e?Promise.reject("invalid symbol"):Promise.resolve(e)})},h.prototype.searchSymbols=function(n,i,a,u){var c=this;return this._readyPromise.then(function(){var r=[],o=0===n.length;n=n.toUpperCase();for(var e=0,t=c._symbolsList;e<t.length;e++)!function(e){var t,s=c._symbolsInfo[e];void 0!==s&&(0<a.length&&s.type!==a||i&&0<i.length&&s.exchange!==i||(t=s.name.toUpperCase().indexOf(n),e=s.description.toUpperCase().indexOf(n),(o||0<=t||0<=e)&&(r.some(function(e){return e.symbolInfo===s})||(e=0<=t?t:8e3+e,r.push({symbolInfo:s,weight:e})))))}(t[e]);var s=r.sort(function(e,t){return e.weight-t.weight}).slice(0,u).map(function(e){e=e.symbolInfo;return{symbol:e.name,full_name:e.full_name,description:e.description,exchange:e.exchange,params:[],type:e.type,ticker:e.name}});return Promise.resolve(s)})},h.prototype._init=function(){for(var e=this,t=[],s={},r=0,o=this._exchangesList;r<o.length;r++){var n=o[r];s[n]||(s[n]=!0,t.push(this._requestExchangeData(n)))}return Promise.all(t).then(function(){e._symbolsList.sort()})},h.prototype._requestExchangeData=function(r){var o=this;return new Promise(function(t,s){o._requester.sendRequest(o._datafeedUrl,"symbol_info",{group:r}).then(function(e){try{o._onExchangeDataReceived(r,e)}catch(e){return void s(e)}t()}).catch(function(e){n(e),t()})})},h.prototype._onExchangeDataReceived=function(t,s){var r=0;try{for(var e=s.symbol.length,o=void 0!==s.ticker;r<e;++r){var n=s.symbol[r],i=l(s,"exchange-listed",r),a=l(s,"exchange-traded",r),u=a+":"+n,c=l(s,"currency-code",r),h=o?l(s,"ticker",r):n,a={ticker:h,name:n,base_name:[i+":"+n],full_name:u,listed_exchange:i,exchange:a,currency_code:c,original_currency_code:l(s,"original-currency-code",r),description:l(s,"description",r),has_intraday:f(l(s,"has-intraday",r),!1),has_no_volume:f(l(s,"has-no-volume",r),!1),minmov:l(s,"minmovement",r)||l(s,"minmov",r)||0,minmove2:l(s,"minmove2",r)||l(s,"minmov2",r),fractional:l(s,"fractional",r),pricescale:l(s,"pricescale",r),type:l(s,"type",r),session:l(s,"session-regular",r),timezone:l(s,"timezone",r),supported_resolutions:f(l(s,"supported-resolutions",r,!0),this._datafeedSupportedResolutions),has_daily:f(l(s,"has-daily",r),!0),intraday_multipliers:f(l(s,"intraday-multipliers",r,!0),["1","5","15","30","60"]),has_weekly_and_monthly:l(s,"has-weekly-and-monthly",r),has_empty_bars:l(s,"has-empty-bars",r),volume_precision:f(l(s,"volume-precision",r),0),format:"price"};this._symbolsInfo[h]=a,this._symbolsInfo[n]=a,this._symbolsInfo[u]=a,void 0!==c&&(this._symbolsInfo[p(h,c)]=a,this._symbolsInfo[p(n,c)]=a,this._symbolsInfo[p(u,c)]=a),this._symbolsList.push(n)}}catch(e){throw new Error("SymbolsStorage: API error when processing exchange "+t+" symbol #"+r+" ("+s.symbol[r]+"): "+e.message)}},h);function h(e,t,s){this._exchangesList=["NYSE","FOREX","AMEX"],this._symbolsInfo={},this._symbolsList=[],this._datafeedUrl=e,this._datafeedSupportedResolutions=t,this._requester=s,this._readyPromise=this._init(),this._readyPromise.catch(function(e){console.error("SymbolsStorage: Cannot init, error="+e.toString())})}function f(e,t){return void 0!==e?e:t}function _(e,t,s){t=e[t];return Array.isArray(t)?t[s]:t}var d=(m.prototype.onReady=function(e){var t=this;this._configurationReadyPromise.then(function(){e(t._configuration)})},m.prototype.getQuotes=function(e,t,s){this._quotesProvider.getQuotes(e).then(t).catch(s)},m.prototype.subscribeQuotes=function(e,t,s,r){this._quotesPulseProvider.subscribeQuotes(e,t,s,r)},m.prototype.unsubscribeQuotes=function(e){this._quotesPulseProvider.unsubscribeQuotes(e)},m.prototype.getMarks=function(e,t,s,r,o){this._configuration.supports_marks&&(o={symbol:e.ticker||"",from:t,to:s,resolution:o},this._send("marks",o).then(function(e){if(!Array.isArray(e)){for(var t=[],s=0;s<e.id.length;++s)t.push({id:_(e,"id",s),time:_(e,"time",s),color:_(e,"color",s),text:_(e,"text",s),label:_(e,"label",s),labelFontColor:_(e,"labelFontColor",s),minSize:_(e,"minSize",s)});e=t}r(e)}).catch(function(e){n(e),r([])}))},m.prototype.getTimescaleMarks=function(e,t,s,r,o){this._configuration.supports_timescale_marks&&(o={symbol:e.ticker||"",from:t,to:s,resolution:o},this._send("timescale_marks",o).then(function(e){if(!Array.isArray(e)){for(var t=[],s=0;s<e.id.length;++s)t.push({id:_(e,"id",s),time:_(e,"time",s),color:_(e,"color",s),label:_(e,"label",s),tooltip:_(e,"tooltip",s)});e=t}r(e)}).catch(function(e){n(e),r([])}))},m.prototype.getServerTime=function(t){this._configuration.supports_time&&this._send("time").then(function(e){e=parseInt(e);isNaN(e)||t(e)}).catch(function(e){n(e)})},m.prototype.searchSymbols=function(e,t,s,r){if(this._configuration.supports_search){var o={limit:30,query:e.toUpperCase(),type:s,exchange:t};this._send("search",o).then(function(e){return void 0!==e.s?(e.errmsg,void r([])):void r(e)}).catch(function(e){n(e),r([])})}else{if(null===this._symbolsStorage)throw new Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.searchSymbols(e,t,s,30).then(r).catch(r.bind(null,[]))}},m.prototype.resolveSymbol=function(e,t,s,r){r=r&&r.currencyCode;function o(e){t(e)}if(this._configuration.supports_group_request){if(null===this._symbolsStorage)throw new Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.resolveSymbol(e,r).then(o).catch(s)}else{e={symbol:e};void 0!==r&&(e.currencyCode=r),this._send("symbols",e).then(function(e){void 0!==e.s?s("unknown_symbol"):o(e)}).catch(function(e){n(e),s("unknown_symbol")})}},m.prototype.getBars=function(e,t,s,r,o){this._historyProvider.getBars(e,t,s).then(function(e){r(e.bars,e.meta)}).catch(o)},m.prototype.subscribeBars=function(e,t,s,r,o){this._dataPulseProvider.subscribeBars(e,t,s,r)},m.prototype.unsubscribeBars=function(e){this._dataPulseProvider.unsubscribeBars(e)},m.prototype._requestConfiguration=function(){return this._send("config").catch(function(e){return n(e),null})},m.prototype._send=function(e,t){return this._requester.sendRequest(this._datafeedURL,e,t)},m.prototype._setupWithConfiguration=function(e){if(void 0===(this._configuration=e).exchanges&&(e.exchanges=[]),!e.supports_search&&!e.supports_group_request)throw new Error("Unsupported datafeed configuration. Must either support search, or support group request");!e.supports_group_request&&e.supports_search||(this._symbolsStorage=new c(this._datafeedURL,e.supported_resolutions||[],this._requester)),JSON.stringify(e)},m);function m(e,t,s,r){var o=this;void 0===r&&(r=1e4),this._configuration=y(),this._symbolsStorage=null,this._datafeedURL=e,this._requester=s,this._historyProvider=new i(e,this._requester),this._quotesProvider=t,this._dataPulseProvider=new a(this._historyProvider,r),this._quotesPulseProvider=new u(this._quotesProvider),this._configurationReadyPromise=this._requestConfiguration().then(function(e){null===e&&(e=y()),o._setupWithConfiguration(e)})}function y(){return{supports_search:!1,supports_group_request:!0,supported_resolutions:["1","5","15","30","60","1D","1W","1M"],supports_marks:!1,supports_timescale_marks:!1}}var b=(g.prototype.getQuotes=function(e){var r=this;return new Promise(function(t,s){r._requester.sendRequest(r._datafeedUrl,"quotes",{symbols:e}).then(function(e){"ok"===e.s?t(e.d):s(e.errmsg)}).catch(function(e){e=n(e);s("network error: "+e)})})},g);function g(e,t){this._datafeedUrl=e,this._requester=t}var v=(P.prototype.sendRequest=function(e,t,s){void 0!==s&&(0!==(r=Object.keys(s)).length&&(t+="?"),t+=r.map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(s[e].toString())}).join("&"));var r={credentials:"same-origin"};return void 0!==this._headers&&(r.headers=this._headers),fetch(e+"/"+t,r).then(function(e){return e.text()}).then(function(e){return JSON.parse(e)})},P);function P(e){e&&(this._headers=e)}var q,w,S,x=(s(w=I,S=q=d),w.prototype=null===S?Object.create(S):(k.prototype=S.prototype,new k),I);function k(){this.constructor=w}function I(e,t){void 0===t&&(t=1e4);var s=new v,r=new b(e,s);return q.call(this,e,r,s,t)||this}e.UDFCompatibleDatafeed=x,Object.defineProperty(e,"__esModule",{value:!0})});
