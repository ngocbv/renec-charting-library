(window.webpackJsonp=window.webpackJsonp||[]).push([["compare-model"],{"1pWb":function(t,e,s){"use strict";function o(t){return!1}s.d(e,"b",(function(){return o})),s.d(e,"a",(function(){return"###"}))},TgrR:function(t,e,s){"use strict";function o(t,e,s){let o;return o=s||e?(s||e)+":"+t:t,o.replace(/<\/?[^>]+(>|$)/g,"")}function n(t){return""===t.value}function i(){const t=a();return t.find(n)||t[0]||null}function r(){return a()}function a(){return window.ChartApiInstance.supportedExchangesList().map(t=>({...t,country:"",providerId:"",flag:""}))}function c(){return window.ChartApiInstance.supportedSymbolsTypes()}function l(){return""}function d(){return!1}s.d(e,"f",(function(){return o})),s.d(e,"g",(function(){return n})),s.d(e,"e",(function(){return i})),s.d(e,"c",(function(){return r})),s.d(e,"d",(function(){return c})),s.d(e,"b",(function(){return l})),s.d(e,"a",(function(){return d}))},cK0E:function(t,e,s){"use strict";s.r(e);var o=s("Eyy1"),n=s("Kxc7"),i=s("jy4L"),r=s("5fI3"),a=s("hY0g"),c=s.n(a),l=s("xlAh"),d=s("cKqi"),h=s("YzC7"),u=s("qC62"),m=s("TgrR");new Set(["short_name","description","exchange","type","country_code","provider_id"]);const b=Object(m.c)(),y={};for(const t of b)y[t.value]={country:t.country,providerId:t.providerId};function S(t){return t instanceof d.study_Overlay||t instanceof h.a}function _(t){if(!t)return;const[e,s]=t.split(":");return s&&e&&y[e]?y[e]:void 0}function f(t,e,s){const o=u.a.fromSymbolInfo(t),n=_(o);return{id:(null==s?void 0:s.id())||o,symbol:o,checked:e,title:t.name,description:t.description,exchangeName:t.exchange,country:null==n?void 0:n.country,providerId:null==n?void 0:n.providerId,marketType:t.type,study:s}}function p(t,e,s,o){return{id:void 0!==s?s.id():t,symbol:t,checked:e,title:t,study:s,description:o}}var g=s("Vdly"),v=s("IWXC"),I=s("1pWb");const w=new Map;class k{constructor(t,e,s="watchlist"){this._symbolDataHandlers=new Map,this._fastSymbols=new Set,this._subscribedSymbols=new Set,this._subscriptionSet=new Set,this._cancelSubscriptionSet=new Set,this._resolvedSymbolsSet=new Set,this._quoteSessionDataHandler=t=>{const e=Object(o.ensureDefined)(t.symbolname),{filtered:s,keepSubscription:n}=this._applyDataFilters(t);n||this._unsubscribeSymbols([e]),this._setSymbolDataCache(e,s);const i=this._symbolDataHandlers.get(e);i&&i(s)},this._clientId=t,this._quoteSession=Object(v.getQuoteSessionInstance)(s),this._lastSymbolData=e||new Map}destroy(){const t=Array.from(this._subscribedSymbols);this._unsubscribeSymbols(t)}addFastSymbol(t){this._fastSymbols.has(t)||!this._subscribedSymbols.has(t)||Object(I.b)(t)||(this._fastSymbols.add(t),this._quoteSession.setFastSymbols(this._clientId,Array.from(this._fastSymbols)))}removeFastSymbol(t){this._fastSymbols.has(t)&&(this._fastSymbols.delete(t),this._quoteSession.setFastSymbols(this._clientId,Array.from(this._fastSymbols)))}addSymbolDataHandler(t,e){Object(I.b)(t)||this._symbolDataHandlers.set(t,e)}removeSymbolDataHandler(t){this._symbolDataHandlers.delete(t)}addToSubscriptionSet(t){t.forEach(t=>{
Object(I.b)(t)||this._subscriptionSet.add(t)})}clearSubscriptionSet(){this._subscriptionSet.clear()}addToCancelSubscriptionSet(t){t.forEach(t=>{Object(I.b)(t)||this._cancelSubscriptionSet.add(t)})}commitSubscriptionChanges(){Array.from(this._subscriptionSet).forEach(t=>{this._cancelSubscriptionSet.has(t)&&(this._subscriptionSet.delete(t),this._cancelSubscriptionSet.delete(t))}),this._subscribeSymbols(Array.from(this._subscriptionSet)),this._subscriptionSet.clear(),this._unsubscribeSymbols(Array.from(this._cancelSubscriptionSet)),this._cancelSubscriptionSet.clear(),this._quoteSession.setFastSymbols(this._clientId,Array.from(this._fastSymbols))}getLastSymbolData(t){return this._lastSymbolData.get(t)}getSymbolSnapshotForAll(t,e,s=guid()){const o=t.map(t=>this.getSymbolSnapshot(t,e,s));return Promise.all(o)}getSymbolSnapshot(t,e,s=guid()){if(Object(I.b)(t))return Promise.resolve(void 0);const o=this._lastSymbolData.get(t);if(o&&"ok"===o.status){const s=this._resolvedSymbolsSet.has(t)&&o.complete;if(C(o,e)||s)return this._resolvedSymbolsSet.add(t),Promise.resolve(o)}return new Promise(o=>{const n=this._clientId+"_snapshot_"+s,i=s=>{const{filtered:r,keepSubscription:a}=this._applyDataFilters(s);r&&"error"!==r.status&&this._setSymbolDataCache(t,r),(!a||C(r,e)||"error"===r.status||r.complete)&&(this._quoteSession.unsubscribe(n,t,i),o(r))};this._quoteSession.subscribe(n,t,i)})}getSymbolFullName(t){if(Object(I.b)(t))return Promise.resolve(t);if(w.has(t))return Object(o.ensureDefined)(w.get(t));const e=new Promise(e=>{const s=this._clientId+"_SymbolFullName",o=n=>{const i=n=>{this._quoteSession.unsubscribe(s,t,o),e(n)};n&&"ok"===n.status?n.values&&i(n.values.pro_name||t):i(t)};this._quoteSession.subscribe(s,t,o)});return w.set(t,e),e}getSymbolsFullNames(t){return Promise.all(t.map(t=>this.getSymbolFullName(t)))}getUniqueSymbolsFullNames(t){return this.getSymbolsFullNames(t).then(t=>Array.from(new Set(t)))}_subscribeSymbols(t){this._quoteSession.subscribe(this._clientId,t,this._quoteSessionDataHandler),t.forEach(t=>this._subscribedSymbols.add(t))}_unsubscribeSymbols(t){this._quoteSession.unsubscribe(this._clientId,t,this._quoteSessionDataHandler),t.forEach(t=>{this._subscribedSymbols.delete(t)})}_setSymbolDataCache(t,e){var s;const o=(null===(s=this._lastSymbolData.get(t))||void 0===s?void 0:s.values)||{};this._resolvedSymbolsSet.add(t),this._lastSymbolData.set(t,{...e,values:{...o,...e.values}})}_applyDataFilters(t){return{filtered:t,keepSubscription:!0}}}const D=new class{constructor(){this._adaptersMap=new Map,this._lastSymbolData=new Map}destroy(){this._adaptersMap.forEach(t=>{t.forEach(t=>t.destroy())}),this._lastSymbolData.clear()}get(t,e="watchlist"){let s;const o=this._adaptersMap.get(t);if(o){const n=o.get(e);n?s=n:(s=new k(t,this._lastSymbolData,e),o.set(e,s))}else{s=new k(t,this._lastSymbolData,e);const o=new Map;o.set(e,s),this._adaptersMap.set(t,o)}return s}};function C(t,e){for(const s of Array.from(e))if(!t.values.hasOwnProperty(s))return!1;return!0}s.d(e,"CompareModel",(function(){return O}));class O{
constructor(t){this._contentItemList=new c.a([]),this._checkedSymbols=new Map,this._recentLength=10,this._adapter=D.get("compare-dialog-adapter"),this._isDataReady=new c.a(!1),this._highlightedSymbol=new c.a(null),this._defaultSymbolsDescriptions=new Map,this._idToStudyMap=new Map,this._chartSession=null,this._recentSymbolsEnabled=n.enabled("compare_recent_symbols_enabled"),this._preventHandleSourcesChange=!0,this.removeStudy=t=>{const{symbol:e,study:s}=t;if(!s)return;this._chartWidget.model().removeSource(s,!1);const o=this._checkedSymbols.get(e);o&&o.length>1?this._removeStudyIdFromCheckedSymbols(e,s.id()):this._checkedSymbols.delete(e),this._updateContentItemList(this._contentItemList.value(),!0)},this._getResolveSymbolPromise=(t,e=Object(i.makeNextSymbolId)())=>{const s=Object(r.encodeExtendedSymbolOrGetSimpleSymbolString)({symbol:t});return new Promise(t=>{Object(o.ensureNotNull)(this._chartSession).resolveSymbol(e,s,e=>{t(e)})})},this._chartWidget=t.activeChartWidget.value(),this._chartSession=this._chartWidget.model().model().chartApi();const e=new Set(this._loadRecent().reverse()),s=new Set,a=new Set,l=this._chartWidget.model().model().dataSources().filter(S),d=l.map(t=>{const e=t.symbolInfo();if(e)return Promise.resolve(u.a.fromSymbolInfo(e));const s=t.symbol();return Object(u.b)(s)});Promise.all(d).then(t=>{const o=t.map((t,e)=>void 0!==t?l[e]:void 0).filter(A);t.filter(A).forEach((t,n)=>{const i=o[n],r=i.id();this._addStudyIdToCheckedSymbols(t,r),this._idToStudyMap.set(r,i),e.has(t)?s.add(t):a.add(t)});const n=Array.from(e).filter(t=>this._checkedSymbols.has(t)).reduce((t,e)=>(s.has(e)&&t.push(e),t),[]).concat(Array.from(a)),r=Array.from(e);if(r.length<this._recentLength){let t;t=[],this._chartWidget.compareSymbols()&&this._chartWidget.compareSymbols().forEach(e=>{t.push(Object(u.b)(e.symbol)),this._defaultSymbolsDescriptions.set(e.symbol,e.title)});const e=[...r,...t];n.push(...e)}else n.push(...r);const c=Array.from(new Set(n));{const t=new Map,e=c.map(e=>{const s=Object(i.makeNextSymbolId)();return t.set(e,s),this._getResolveSymbolPromise(e,s)});Promise.all(e).then(e=>this._handleInitProcess(n,s=>{const o=t.get(s);return e.find(t=>t.params[0]===o)},(t,e)=>u.a.fromSymbolMessage(e,t),(t,e,s,o)=>"symbol_resolved"===t.method?f(t.params[1],s,o):p(e,s,o,this._getSymbolDescription(e))))}})}chartModel(){return this._chartWidget.model().model()}handleSourcesChange(){if(this._preventHandleSourcesChange)return;const t=this.chartModel().dataSources().filter(S),e=new Set(t.map(t=>t.id()));Array.from(e).forEach(t=>{if(!this._checkedStudiesIds().has(t)){const e=this.chartModel().dataSourceForId(t)||null;if(null!==e&&S(e)){const e=this._getContentItemByStudyId(t);if(!e)return;this._addStudyIdToCheckedSymbols(e.symbol,t),this._saveRecent(e.symbol),this._updateContentItemList(this._contentItemList.value(),!0)}}});Array.from(this._checkedStudiesIds()).forEach(t=>{if(!e.has(t)){const e=this._getContentItemByStudyId(t);if(!e)return;const s=this._checkedSymbols.get(e.symbol)
;s&&s.length>1?this._removeStudyIdFromCheckedSymbols(e.symbol,t):this._checkedSymbols.delete(e.symbol),this._updateContentItemList(this._contentItemList.value(),!0)}})}studies(){return this._contentItemList.readonly()}isDataReady(){return this._isDataReady.readonly()}highlightedSymbol(){return this._highlightedSymbol.readonly()}applyStudy(t,e,s){const o=this._chartWidget;if(!o)return;if(Object(I.b)(t))return;let n;switch(e){case l.a.SameScale:n=o.addCompareAsOverlay(t,s);break;case l.a.NewPriceScale:n=o.addOverlayStudy(t,!0,s);break;case l.a.NewPane:n=o.addOverlayStudy(t,!1,s)}Promise.all([this._getResolveSymbolPromise(t),n]).then(e=>this._handleApplyProcess(e,e=>u.a.fromSymbolMessage(t,e),(t,e,s)=>"symbol_resolved"===t.method?f(t.params[1],!0,s):p(e,!0,s)))}_handleApplyProcess(t,e,s){const[o,n]=t;if(!o||null===n)return;const i=n.id(),r=e(o),a=s(o,r,n);this._saveRecent(r),this._addStudyIdToCheckedSymbols(r,i),this._showNewItem(a,r,i)}_handleInitProcess(t,e,s,o){const n=[];for(const i of t){const t=e(i);if(!t)continue;const r=s(t,i),a=this._checkedSymbols.get(r),c=-1!==n.findIndex(t=>t.symbol===r);if(void 0===a||c)this._recentSymbolsEnabled&&n.push(o(t,r,!1));else for(const e of a)n.push(o(t,r,!0,this._idToStudyMap.get(e)))}this._updateContentItemList(n),this._isDataReady.setValue(!0)}_showNewItem(t,e,s){const o=this._contentItemList.value().map(this._updateChecked,this);o.unshift(t),this._recentSymbolsEnabled&&o.unshift({...t,id:e,study:void 0,checked:!1}),this._updateContentItemList(o),this._highlightedSymbol.setValue(s),setTimeout(()=>this._highlightedSymbol.setValue(null),500)}_addStudyIdToCheckedSymbols(t,e){const s=this._checkedSymbols.get(t)||[];this._checkedSymbols.set(t,[...s,e])}_removeStudyIdFromCheckedSymbols(t,e){const s=this._checkedSymbols.get(t);if(s){const o=s.indexOf(e);s.splice(o,1),this._checkedSymbols.set(t,s)}}_updateChecked(t){var e;const s=this._checkedSymbols.get(t.symbol),o=null===(e=t.study)||void 0===e?void 0:e.id();return o?{...t,checked:Boolean(s&&s.includes(o))}:t}_updateContentItemList(t,e){const s=e?t.map(this._updateChecked,this):t,o=s.filter(t=>t.checked);if(this._recentSymbolsEnabled){const t=new Set,e=s.reduce((e,s)=>(s.checked||t.has(s.symbol)||(e.push(s),t.add(s.symbol)),e),[]).slice(0,this._recentLength);this._contentItemList.setValue(o.concat(e))}else this._contentItemList.setValue(o)}_checkedStudiesIds(){const t=[].concat(...Array.from(this._checkedSymbols.values()));return new Set(t)}_getContentItemByStudyId(t){const e=this._contentItemList.value(),s=e.findIndex(e=>e.study&&e.study.id()===t);return e[s]}_loadRecent(){return this._recentSymbolsEnabled?g.getJSON("CompareDialog.recent",[]):[]}_saveRecent(t){if(!this._recentSymbolsEnabled)return;const e=new Set(this._loadRecent());e.has(t)&&e.delete(t),e.add(t),g.setJSON("CompareDialog.recent",Array.from(e).slice(-this._recentLength))}_getSymbolDescription(t){var e;return this._defaultSymbolsDescriptions.size&&null!==(e=this._defaultSymbolsDescriptions.get(t))&&void 0!==e?e:""}}function A(t){return void 0!==t}},
qC62:function(t,e,s){"use strict";s.d(e,"b",(function(){return r})),s.d(e,"a",(function(){return o}));var o,n=s("Eyy1"),i=s("Kxc7");s("TgrR");function r(t){return t}!function(t){function e(t){return t.pro_name}function s(t){{const e=i.enabled("pay_attention_to_ticker_not_symbol")?t.ticker:t.full_name;return Object(n.ensureDefined)(e)}}t.fromQuotesResponse=function(t){const{values:s,symbolname:o,status:n}=t;return"error"===n&&o?o:e(s)},t.fromQuotes=e,t.fromSymbolSearchResult=function(t,e){{const{ticker:s,full_name:o}=null!=e?e:t;return i.enabled("pay_attention_to_ticker_not_symbol")?Object(n.ensureDefined)(null!=s?s:o):Object(n.ensureDefined)(o)}},t.fromSymbolInfo=s,t.fromSymbolMessage=function(t,e){return"symbol_resolved"===e.method?s(e.params[1]):t}}(o||(o={}))},xlAh:function(t,e,s){"use strict";var o;s.d(e,"a",(function(){return o})),function(t){t[t.SameScale=0]="SameScale",t[t.NewPriceScale=1]="NewPriceScale",t[t.NewPane=2]="NewPane"}(o||(o={}))}}]);